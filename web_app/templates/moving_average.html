{% extends './partials/base.html'%}
{% block content %} 
{{ data|json_script:'data' }}
<ul class="nav justify-content-center">
    <li class="nav-item">
        <a class="nav-link" href="/forecasting/linear_regression">Linear Regression</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/forecasting/exponential_smoothing">Exponential Smoothing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="/forecasting/moving_average">Moving Average</a>
    </li>
</ul>
<input type="number" placeholder="3" id="periods">
<label for="periods">Enter the number of periods for forecasting</label>
<div id="scatter_chart" style="width: 800px; height: 500px;"></div>
{% endblock %}



{% block scripts %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    const data = JSON.parse(document.getElementById('data').textContent);

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);
    periods = document.getElementById('periods');
    periods.addEventListener('change', () => {
        google.charts.setOnLoadCallback(drawChart(parseInt(periods.value)));
    })
    
    

    function drawChart(per_num=3) {
        const months = Object.keys(data);
        const values = Object.values(data);
        let lastMonth = parseInt(Object.keys(data)[Object.keys(data).length -1].slice(-2));
        let lastYear = parseInt(Object.keys(data)[Object.keys(data).length -1].slice(0,-2));
        const extraMonths = [];
        for (let i=1; i<=per_num; i++){
            if(lastMonth<12){
                lastMonth += 1;
                extraMonths.push(lastYear+'-'+lastMonth)
            } else {
                lastMonth = 1;
                lastYear +=1 ;
                extraMonths.push(lastYear+'-'+lastMonth)
            }
        }
        const lastValue = values[values.length - 1];
        const extraValues = []
        for (let i=1; i<=per_num; i++){
            temp_List = values.concat(extraValues);
            let newValue = (temp_List.at(-1)+temp_List.at(-2)+temp_List.at(-3))/3;
            extraValues.push(newValue);
        }
        const chartData = [
          ['Month', 'Actual Data', 'Forecast', 'Bridge']
        ];
        months.forEach((month, i) => {
            const bridgeValue = (i === months.length - 1) ? values[i] : null;
            chartData.push([month, values[i], null, bridgeValue]);
        });
        extraMonths.forEach((month, i) => {
            const bridgeValue = (i === 0) ? extraValues[i] : null;
            chartData.push([month, null, extraValues[i], bridgeValue]);
        });
        const dataTable = google.visualization.arrayToDataTable(chartData);
        const options = {
          hAxis: { title: 'Month' },
          vAxis: { title: 'Value' },
          legend: 'bottom',
          series: {
            0: { color: '#4285F4', lineWidth: 2 },
            1: {color: '#FF5733', lineWidth: 2, lineDashStyle: [4, 4]},
            2: { color: '#FF5733', lineWidth: 2, lineDashStyle: [2, 4], visibleInLegend: false }
            
          },
          pointSize: 6
        };
        const chart = new google.visualization.LineChart(document.getElementById('scatter_chart'));
        chart.draw(dataTable, options);
      }
</script>
{% endblock %}